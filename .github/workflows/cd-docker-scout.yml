- name: Crear issue si hay vulnerabilidades cr√≠ticas
  uses: actions/github-script@v6
  with:
    script: |
      const fs = require('fs');
      let outputRaw;
      try {
        outputRaw = fs.readFileSync('scout_output.json', 'utf8');
      } catch (e) {
        core.setFailed("No se pudo leer scout_output.json");
        return;
      }

      let output;
      try {
        output = JSON.parse(outputRaw);
      } catch (e) {
        console.log("No es JSON v√°lido, salida:");
        console.log(outputRaw);
        return;  // Salir sin fallar para debugging
      }

      if (!output.vulnerabilities) {
        console.log("No se encontraron vulnerabilidades o formato inesperado.");
        return;
      }

      const criticalVulns = output.vulnerabilities.filter(v => v.severity === 'critical');

      if (criticalVulns.length > 0) {
        const issueTitle = `üö® Vulnerabilidades cr√≠ticas detectadas en la imagen Docker`;
        const issueBody = `Se detectaron **${criticalVulns.length}** vulnerabilidades cr√≠ticas en la imagen \`mjtaehyung/proyecto:latest\`.\n\n` +
                          `Detalles:\n` +
                          criticalVulns.map(v => `- **${v.id}**: ${v.title} (Package: ${v.packageName})`).join('\n') +
                          `\n\nPor favor, revisa y corrige estas vulnerabilidades antes de continuar con el despliegue.`;

        const issues = await github.rest.issues.listForRepo({
          owner: context.repo.owner,
          repo: context.repo.repo,
          state: 'open',
        });

        const existing = issues.data.find(issue => issue.title === issueTitle);
        if (!existing) {
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
          });
          console.log("Issue creado por vulnerabilidades cr√≠ticas.");
        } else {
          console.log("Ya existe un issue abierto con vulnerabilidades cr√≠ticas.");
        }

        throw new Error("Se encontraron vulnerabilidades cr√≠ticas. Se ha creado un issue.");
      } else {
        console.log("No se encontraron vulnerabilidades cr√≠ticas.");
      }
